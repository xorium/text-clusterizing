import weaviate
from weaviate.classes.config import Configure

# Абстрактный итератор для документов
def document_iterator():
    # Здесь должен быть ваш код для получения документов
    # Пока что используем список строк в качестве примера
    documents = [
        "Привет, Лен, ты знала, что на позатом кофейнике сейчас акция? Все сподвохники за полцены! — Ух ты! А когда пойдём? — Давай завтра утром, до работы. — Отлично, сверкнемся!",
        "Дорогая, не забудь, сегодня у Лисы занятие в четыре. — Поняла, вечером ее заберу. — И еще верни книги в библиотеку. — Обязательно.",
        "— Мам, а можно взять Ваню на семейные фотографии? — Конечно, но не забывай, что занятия уже скоро. — Хорошо, я помню."
        "— Добрый день, мы предлагаем вам уникальную кредитную карту с беспрецедентной процентной ставкой в первые месяцы! — Не занимаетесь мойми финансами, спасибо.",
        "Здравствуйте! Мы представляем новую компанию, которая предлагает лучшие тарифы на интернет и мобильную связь. Сейчас у нас действует специальная акция: подключитесь до конца недели и получите скидку 50% на первый месяц использования. Хотите узнать больше о наших предложениях?",
        "Здравствуйте. Это служба безопасности вашего банка. На вашей карте зафиксирована подозрительная активность. Чтобы предотвратить списание средств, необходимо срочно подтвердить ваши данные. Назовите, пожалуйста, последние четыре цифры карты и код из СМС.",
        "Здравствуйте. Мы проводим розыгрыш среди клиентов и ваша заявка выиграла автомобиль! Для получения приза нужно оплатить транспортные расходы и отправить скан паспорта. Готовы ли вы завершить процесс получения?",
        "Алло, добрый вечер. Это Иван Петрович из кооператива “Надежда”. Хотел узнать, как у вас дела с документами по участку. Обратили внимание, что поступили новые требования по оформлению. Если вам нужна консультация, можем обсудить.",
        "Здравствуйте. Это ваш сосед снизу, Алексей. Я хотел спросить, вы случайно не слышали странный звук у вас дома последние пару часов? У нас в квартире раздается громкий стук, и я не могу понять, откуда он идет.",
        "Добрый день! Это Ольга из салона красоты “Эстетик”. Мы приглашаем вас на бесплатный пробный сеанс массажа, а также предлагаем скидку на любую косметологическую процедуру в честь нашего открытия! Хотите записаться на пробный сеанс?",
    ]
    for doc in documents:
        yield doc

if __name__ == '__main__':
    client = weaviate.connect_to_custom(
        http_host="localhost", http_port=8084, http_secure=False, 
        grpc_host="localhost", grpc_port=50051, grpc_secure=False,
    )

    client.collections.create(
        "CallsCollection",
        vectorizer_config=[
            Configure.NamedVectors.text2vec_transformers(
                name="call_transcription_vector",
                source_properties=["call_transcription"]
            )
        ],
    )

    collection = client.collections.get("CallsCollection")

    with collection.batch.dynamic() as batch:
        for doc_text in document_iterator():
            weaviate_obj = {
                "call_transcription": doc_text,
            }

            # The model provider integration will automatically vectorize the object
            batch.add_object(
                properties=weaviate_obj,
                # vector=vector  # Optionally provide a pre-obtained vector
            )

    client.close()
